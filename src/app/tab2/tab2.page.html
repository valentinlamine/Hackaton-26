<ion-content [fullscreen]="true" class="map-content">
  <!-- Map container -->
  <div id="map-container" class="map-container">
    <div id="map" class="map"></div>
    
    <!-- Center on user location button -->
    <ion-fab vertical="bottom" horizontal="end" slot="fixed">
      <ion-fab-button (click)="centerOnUserLocation()" color="primary">
        <ion-icon name="locate"></ion-icon>
      </ion-fab-button>
    </ion-fab>
  </div>

  <!-- Loading indicator -->
  <div *ngIf="isLoading" class="loading-overlay">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Chargement de la carte...</p>
  </div>

  <!-- Photos list modal for clusters -->
  <ion-modal [isOpen]="mapState.photosListOpen" (didDismiss)="closePhotosList()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Photos de la zone</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closePhotosList()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <ion-grid *ngIf="mapState.photosListPhotos.length; else emptyState">
          <ion-row>
            <ion-col size="6" *ngFor="let photo of mapState.photosListPhotos; index as position" 
                     (click)="openViewer(position)">
              <div class="photo-tile">
                <ion-img [src]="photo.webviewPath"></ion-img>
                <ion-button *ngIf="!selectionMode" fill="clear" class="like-btn" (click)="toggleLike(photo.filepath)">
                  <ion-icon [name]="isLiked(photo.filepath) ? 'heart' : 'heart-outline'" 
                            [color]="isLiked(photo.filepath) ? 'danger' : 'light'"></ion-icon>
                </ion-button>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>

        <ng-template #emptyState>
          <div style="padding: 16px; text-align: center; opacity: 0.7;">Aucune photo dans cette zone</div>
        </ng-template>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Photo viewer component -->
  <app-photo-viewer
    [isOpen]="mapState.viewerOpen"
    [photos]="mapState.viewerPhotos"
    [currentIndex]="mapState.viewerCurrentIndex"
    [viewerControlsVisible]="mapState.viewerControlsVisible"
    [swipeOffset]="mapState.viewerSwipeOffset"
    [swipeTransition]="mapState.viewerSwipeTransition"
    [verticalOffset]="mapState.viewerVerticalOffset"
    [verticalTransition]="mapState.viewerVerticalTransition"
    [metadataVisible]="mapState.viewerMetadataVisible"
    [metadataOffset]="mapState.viewerMetadataOffset"
    [metadataTransition]="mapState.viewerMetadataTransition"
    [likedFilepaths]="photoService.getLikedFilepaths()"
    (close)="closeViewer()"
    (nextPhoto)="nextPhoto()"
    (prevPhoto)="prevPhoto()"
    (viewerClick)="onViewerClick($event)"
    (touchStart)="onTouchStart($event)"
    (touchMove)="onTouchMove($event)"
    (touchEnd)="onTouchEnd($event)"
    (metadataTouchStart)="onMetadataTouchStart($event)"
    (metadataTouchMove)="onMetadataTouchMove($event)"
    (metadataTouchEnd)="onMetadataTouchEnd($event)"
    (toggleLike)="toggleLike($event)"
    (deleteCurrent)="deleteCurrentPhoto()">
  </app-photo-viewer>

</ion-content>
